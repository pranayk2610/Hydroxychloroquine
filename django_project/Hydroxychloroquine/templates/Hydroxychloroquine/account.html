{% extends "Hydroxychloroquine/base.html" %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'Hydroxychloroquine/account.css' %}" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock style %}
{% block content %}

  <!-- User's personal information -->
  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit Account</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form method="POST">
            {% csrf_token %}
            {{form_userchange}}
            <input type="submit" name="username_change" value="Save Changes">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <!--<button type="submit" class="btn btn-primary">Save changes</button>-->
        </div>
      </div>
    </div>
  </div>
  <div class="container" id="accountInfo">
    <div class="col justify-content-center">
      <div class="row justify-content-center">
          <h1>My Account</h1>
      </div>
      <div class="row">
          <div class="col-4 justify-content-center">
              <div class="row justify-content-center">
                  <h2>Personal Information</h2>
              </div>
              <div class="row justify-content-center">
                  <ul class="list-group">
                    <li class="list-group-item">Name</li>
                    <li class="list-group-item">Email</li>
                    <!-- <li class="list-group-item">UGA ID</li> -->
                  </ul>
                  <ul class="list-group">
                    <li class="list-group-item">{{request.user.display_name}}</li>
                    <li class="list-group-item">{{request.user.email}}</li>
                    <!-- <li class="list-group-item">nrc10711</li> -->
                  </ul>
              </div>
              <div class="row row-edit justify-content-center">
                <button type="button" id="editButton" class="btn btn-secondary" data-toggle="modal" data-target="#editModal"
                  style="margin: 15px;">Edit Account</button>
                <a href="{% url 'password_change' %}" id="editButton" class="btn btn-secondary" style="margin: 15px;"> Change
                  Password</a>
              </div>
          </div>
          <div class="col-8 justify-content-center">
              <div class="row justify-content-center">
                  <h2>Selected Buildings</h2>
              </div>
              <div class="row justify-content-center">
                  <div class="col justify-content-center overflow-auto" style="max-height: 200px;">
                      <ul class="list-group">
                          <div class="row">
                             <div class="col-2">
                                 <h5>Building</h5>
                             </div>
                             <div class="col-2">
                                 <h5>Start Time</h5>
                             </div>
                             <div class="col-2">
                                 <h5>End Time</h5>
                             </div>
                             <div class="col-2">

                             </div>
                          </div>
                          {% for excur in users_excursions %}
                          <div class="row align-items-center" id="cur_excursion{{ excur.id }}">
                              <div class="col-2"> {{ excur.building_id}} </div>
                              {% with '1 2 3 4 5 6 7' as days %}
                                {% for day in days.split %}
                                <div class="col">
                                  <input name="{{ excur.id }}_{{ day }}" id="update_days{{ excur.id }}_{{ day }}" class="form-check-input"
                                    type="checkbox" value="{{ day }}" {% if day in excur.days_selected %} checked {% endif %}>
                                  <!-- <label for="id_excursions-{{ i }}-{{ day }}" class="form-check-label">{{ day }}</label> -->
                                </div>
                                {% endfor %}
                              {% endwith %}
                              <div class="col-2"> {{ excur.start_time}} </div>
                              <div class="col-2"> {{ excur.end_time}} </div>
                              <div class="col-2">
                                 <input type="button" class="btn btn-danger" id="remove_building{{ excur.id }}"
                                   name="{{excur.id}}" value="Delete" style="margin:10px;" />
                              </div>
                          </div>
                          {% endfor %}
                      </ul>
                  </div>
              </div>
          </div>
      </div>
    </div>
    <div class="row justify-content-around">
    </div>
      <!-- User's selected buildings-->
    <div class="form-group col top">
    <h4>Select which buildings and times you would like to be notified for potential covid exposure</h4>
    <p style="color:gray">
        Please select the buildings you are usually in during an average week, along with the time range and day range.
        For the buildings you sign up for, you will be notified if someone reports a positive test and frequents
        those same buildings at the same times and on the same days.
    </p>
    <form method="POST">
      {% csrf_token %}
       {% include "Hydroxychloroquine/selectBuildings.html" %}
      <input type="submit" class="btn btn-secondary" name="add_buildings" value="Submit buildings">
    </form>
  </div>
  </div>
</div>
<!-- Buildings the user selected -->
<!-- This is mostly hardcoded for the purpose of the UI demo. Our Actual website will probably need a list with its own scrollbar. -->
<div class="form-gap"></div>
<script>
  // reloads window if reached through forward backwards buttons
  // https://stackoverflow.com/questions/9046184/reload-the-site-when-reached-via-browsers-back-button
  if(!!window.performance && window.performance.navigation.type == 2){
      window.location.reload();
  }
  // based on https://stackoverflow.com/questions/14007453/my-own-like-button-django-ajax-how
  {% for excur in users_excursions %}
    $('#remove_building{{ excur.id }}').click(function(){
      // $("#cur_excursion{{ excur.id }}").hide();
      $.ajax({
        type: "POST",
        url: "{% url 'ajax_remove_building' %}",
        data: {'excursion_id': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        dataType: "json",
        success: function(response) {
              $("#cur_excursion{{ excur.id }}").hide();
              // maybe do something else?
              // $(this).attr('value').hide();
              // alert(response.message);
        },
        error: function(rs, e) {
              alert('Error: Failed to delete Building. Please try refreshing Page');
              // alert(rs.responseText);
        }
      });
    });
    {% with '1 2 3 4 5 6 7' as days %}
      {% for day in days.split %}
        $('#update_days{{ excur.id }}_{{ day }}').click(function(){
          $.ajax({
            type: "POST",
            url: "{% url 'ajax_update_days' %}",
            data: {
              'excursion_id_day': $(this).attr('name'),
              'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            dataType: "json",
            success: function(response) {
                  // maybe do something?
            },
            error: function(rs, e) {
                  alert('Error: Failed to delete Building. Please try refreshing Page');
                  // alert(rs.responseText);
            }
          });
        });
      {% endfor %}
    {% endwith %}
  {% endfor %}
</script>
{% endblock content %}
